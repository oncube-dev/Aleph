# Архитектура Aleph Messenger

## Обзор системы

Aleph Messenger - это клиент-серверное приложение для обмена сообщениями и голосовых звонков, построенное на Python с использованием PyQt5 для пользовательского интерфейса.

## Компоненты системы

### 1. Клиентская часть (main.py)
- **Точка входа** в приложение
- **Окно аутентификации** - для входа пользователей
- **Главное окно** - основной интерфейс мессенджера
- **Управление жизненным циклом** приложения

### 2. Серверная часть (src/core/server.py)
- **Центральный сервер** для обработки сообщений
- **Управление подключениями** клиентов
- **Маршрутизация сообщений** между пользователями
- **Мониторинг состояния** пользователей

### 3. Сетевое взаимодействие (src/network/network_manager.py)
- **TCP соединения** для текстовых сообщений
- **UDP соединения** для аудио данных
- **Протокол обмена сообщениями** в формате JSON
- **Heartbeat механизм** для проверки активности

### 4. База данных (src/database/database.py)
- **SQLite база данных** для локального хранения
- **Таблицы**: users, messages, contacts
- **CRUD операции** для всех сущностей
- **Автоматическое создание** тестовых пользователей

### 5. Аудио система (src/audio/audio_manager.py)
- **Запись аудио** с микрофона
- **Воспроизведение аудио** через динамики
- **UDP передача** аудио данных
- **Буферизация** для плавного воспроизведения

### 6. Пользовательский интерфейс
- **auth_window.py** - окно входа
- **main_window.py** - главное окно с чатом и контактами

## Поток данных

### Отправка сообщения
1. Пользователь вводит текст в поле ввода
2. `MainWindow` создает JSON сообщение
3. `NetworkManager` отправляет через TCP сокет
4. Сервер получает и маршрутизирует сообщение
5. Получатель получает сообщение через свой `NetworkManager`
6. `MainWindow` отображает сообщение в чате

### Голосовой звонок
1. Пользователь нажимает кнопку звонка
2. Отправляется `call_request` через TCP
3. При принятии создается UDP соединение для аудио
4. `AudioManager` начинает запись и воспроизведение
5. Аудио данные передаются через UDP в реальном времени

## Сетевая архитектура

### Протоколы
- **TCP 47990** - управляющие сообщения, аутентификация
- **UDP 47990** - аудио данные для звонков

### Типы сообщений
```json
{
    "type": "message_type",
    "sender_id": "user_id",
    "receiver_id": "target_user_id",
    "message_text": "текст сообщения",
    "timestamp": 1234567890
}
```

### Обработка сообщений
Каждый тип сообщения имеет свой обработчик в `NetworkManager`:
- `auth_request` - аутентификация пользователя
- `message` - текстовое сообщение
- `call_request` - запрос на звонок
- `heartbeat` - проверка активности

## Безопасность

### Текущие меры
- **Простая аутентификация** по ID пользователя
- **Валидация** входящих сообщений
- **Ограничение** размера сообщений

### Рекомендации по улучшению
- Добавить шифрование сообщений
- Реализовать аутентификацию по паролю
- Добавить проверку целостности данных

## Масштабируемость

### Текущие ограничения
- **Один сервер** для всех подключений
- **Локальная база данных** SQLite
- **Отсутствие** балансировки нагрузки

### Возможности расширения
- **Кластер серверов** с балансировщиком
- **PostgreSQL/MySQL** для централизованной БД
- **Redis** для кэширования и сессий
- **WebSocket** для веб-клиентов

## Мониторинг и логирование

### Текущий функционал
- **Консольные логи** для отладки
- **Статистика подключений** каждые 30 секунд
- **Обработка ошибок** с выводом в консоль

### Рекомендации
- Добавить структурированное логирование
- Интеграция с системами мониторинга
- Метрики производительности

## Тестирование

### Текущие тесты
- `test_app.py` - базовые тесты приложения
- `test_chat_update.py` - тесты обновления чата

### Рекомендации
- Добавить unit-тесты для каждого модуля
- Интеграционные тесты для сетевого взаимодействия
- Автоматизированные тесты UI
